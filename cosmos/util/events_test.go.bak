package util

import (
	"testing"

	"cosmossdk.io/math"
	abci "github.com/cometbft/cometbft/abci/types"
	sdk "github.com/cosmos/cosmos-sdk/types"
	"github.com/stretchr/testify/assert"
)

func TestParseTransferEvents(t *testing.T) {
	denom := "upokt"
	tests := []struct {
		name        string
		events      []abci.Event
		expectedSp  string
		expectedAmt sdk.Coin
		expectedErr string
	}{
		{
			name: "Transfer",
			events: []abci.Event{
				{Type: "transfer", Attributes: []abci.EventAttribute{
					{Key: ("spender"), Value: ("pokt1abcd")},
					{Key: ("amount"), Value: ("100upokt")},
				}},
			},
			expectedSp:  "pokt1abcd",
			expectedAmt: sdk.NewCoin(denom, math.NewInt(100)),
			expectedErr: "",
		},
		{
			name: "Invalid Denom",
			events: []abci.Event{
				{Type: "transfer", Attributes: []abci.EventAttribute{
					{Key: ("spender"), Value: ("pokt1abcd")},
					{Key: ("amount"), Value: ("100invalid")},
				}},
			},
			expectedSp:  "pokt1abcd",
			expectedAmt: sdk.NewCoin(denom, math.NewInt(0)),
			expectedErr: "invalid coin denom",
		},
		{
			name: "Invalid Amount",
			events: []abci.Event{
				{Type: "transfer", Attributes: []abci.EventAttribute{
					{Key: ("spender"), Value: ("pokt1abcd")},
					{Key: ("amount"), Value: ("invalid")},
				}},
			},
			expectedSp:  "pokt1abcd",
			expectedAmt: sdk.NewCoin(denom, math.NewInt(0)),
			expectedErr: "invalid decimal coin expression: invalid",
		},
		{
			name: "Multiple Spenders",
			events: []abci.Event{
				{Type: "transfer", Attributes: []abci.EventAttribute{
					{Key: ("spender"), Value: ("pokt1abcd")},
					{Key: ("amount"), Value: ("100upokt")},
				}},
				{Type: "transfer", Attributes: []abci.EventAttribute{
					{Key: ("spender"), Value: ("pokt1efgh")},
					{Key: ("amount"), Value: ("100upokt")},
				}},
			},
			expectedSp:  "pokt1abcd",
			expectedAmt: sdk.NewCoin(denom, math.NewInt(100)),
			expectedErr: "multiple spenders found in coin spent events",
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			spender, amount, err := ParseTransferEvents(denom, tt.events)
			if tt.expectedErr != "" {
				assert.Error(t, err)
				assert.Contains(t, err.Error(), tt.expectedErr)
			} else {
				assert.NoError(t, err)
				assert.Equal(t, tt.expectedSp, spender)
				assert.Equal(t, tt.expectedAmt, amount)
			}
		})
	}
}
